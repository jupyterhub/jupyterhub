{% extends "page.html" %}
{% block main %}
  <div class="container">
    <div class="row">
      <div class="text-center">
        {% block message %}
          <p>Your server is starting up.</p>
          <p>You will be redirected automatically when it's ready for you.</p>
        {% endblock message %}
        <div class="progress">
          <div id="progress-bar"
               class="progress-bar"
               role="progressbar"
               aria-valuenow="0"
               aria-valuemin="0"
               aria-valuemax="100">
            <span class="sr-only"><span id="sr-progress">0%</span> Complete</span>
          </div>
        </div>
        <!-- Stop Server Button -->
        <div class="mt-3">
          <button id="stop-server-btn" class="btn btn-danger btn-sm">Stop Server</button>
          <div id="stop-server-status" class="mt-2" style="display: none;"></div>
        </div>
        <p id="progress-message"></p>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-md-8">
        <details id="progress-details">
          <summary>Event log</summary>
          <div id="progress-log"></div>
        </details>
      </div>
    </div>
  </div>
{% endblock main %}
{% block script %}
  {{ super() }}
  <script type="text/javascript">
    require(["jquery"], function($) {
      var base_url = window.jhdata ? window.jhdata.base_url : "{{ base_url }}";
      var user = window.jhdata ? window.jhdata.user : "{{ user.name }}";

      $("#refresh").click(function() {
        window.location.reload();
      });

      // Try to load JHAPI for stop server functionality
      require(["jhapi"], function(JHAPI) {
        var api = new JHAPI(base_url);

        // Stop Server Button Handler
        $("#stop-server-btn").click(function() {
          var button = $(this);
          var statusDiv = $("#stop-server-status");

          // Disable button and show loading state
          button.prop('disabled', true).text('Stopping...');
          statusDiv.show().removeClass('alert-success alert-danger').addClass('alert alert-info').text('Stopping server...');

          // Use JHAPI to stop server
          api.stop_server(user, {
            success: function() {
              statusDiv.removeClass('alert-info alert-danger').addClass('alert-success').text('Server stopped successfully!');
              // Redirect or reload after successful stop
              setTimeout(function() {
                window.location.reload();
              }, 2000);
            },
            error: function(xhr, status, error) {
              console.error('Error stopping server:', error);
              var errorMessage = 'Error stopping server';
              if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage += ': ' + xhr.responseJSON.message;
              } else if (error) {
                errorMessage += ': ' + error;
              }
              statusDiv.removeClass('alert-info alert-success').addClass('alert-danger').text(errorMessage);
              button.prop('disabled', false).text('Stop Server');
            }
          });
        });
      }, function(err) {
        // JHAPI not available, disable stop server functionality
        console.log('JHAPI not available, disabling stop server functionality');
        $("#stop-server-btn").prop('disabled', true).text('Stop Server (not available)');
      });

      // hook up event-stream for progress
      var evtSource = new EventSource("{{ progress_url }}");
      var progressMessage = $("#progress-message");
      var progressBar = $("#progress-bar");
      var srProgress = $("#sr-progress");
      var progressLog = $("#progress-log");

      evtSource.onmessage = function(e) {
        var evt = JSON.parse(e.data);
        console.log(evt);
        if (evt.progress !== undefined) {
          // update progress
          var progText = evt.progress.toString();
          progressBar.attr('aria-valuenow', progText);
          srProgress.text(progText + '%');
          progressBar.css('width', progText + '%');
        }
        // update message
        var html_message;
        if (evt.html_message !== undefined) {
          progressMessage.html(evt.html_message);
          html_message = evt.html_message;
        } else if (evt.message !== undefined) {
          progressMessage.text(evt.message);
          html_message = progressMessage.html();
        }
        if (html_message) {
          progressLog.append(
            $("<div>")
            .addClass('progress-log-event')
            .html(html_message)
          );
        }

        if (evt.ready) {
          evtSource.close();
          // reload the current page
          // which should result in a redirect to the running server
          window.location.reload();
        }

        if (evt.failed) {
          evtSource.close();
          // turn progress bar red
          progressBar.addClass('progress-bar-danger');
          // open event log for debugging
          $('#progress-details').prop('open', true);
        }
      };

      // signal that page has finished loading (mostly for tests)
      window._jupyterhub_page_loaded = true;
    });
  </script>
{% endblock script %}
